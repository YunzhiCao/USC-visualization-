<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Deck.gl + Mapbox | USC Buildings</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/deck.gl@8.9.30/dist.min.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #controls {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      z-index: 1;
    }
    button {
      margin: 4px 0;
      width: 120px;
    }
  </style>
</head>
<body>
<div id="controls">
  <button onclick="highlightDecade(1970, 1980)">1970â€“1980</button>
  <button onclick="highlightDecade(2000, 2010)">2000â€“2010</button>
  <button onclick="highlightDecade(1900, 2100)">Reset</button>
</div>

<script>
const MAPBOX_TOKEN = 'pk.eyJ1IjoicmljaGllNjE5IiwiYSI6ImNtN3YxY21sbDA2cm0ycnEycXVwa2NmemUifQ.VG0n1YWFUalWfyEvxQv4yg'; // âš ï¸ è¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„ Mapbox å…¬å…± token

const INITIAL_VIEW_STATE = {
  longitude: -118.285,
  latitude: 34.021,
  zoom: 16,
  pitch: 45,
  bearing: 0
};

let deckgl;
let wallLayer, roofLayer;

function getHeightExpression(start, end) {
  return feature => {
    const y = +feature.properties.yearBuilt;
    return (y >= start && y < end) ? 40 : 10;
  };
}

function highlightDecade(start, end) {
  const getHeight = getHeightExpression(start, end);

  wallLayer = wallLayer.clone({ getElevation: getHeight });
  roofLayer = roofLayer.clone({ getElevation: getHeight });

  deckgl.setProps({ layers: [wallLayer, roofLayer] });
}

fetch('map.geojson')
  .then(res => res.json())
  .then(data => {
    const getHeight = getHeightExpression(1900, 2100);

    wallLayer = new deck.PolygonLayer({
      id: 'building-walls',
      data: data.features,
      getPolygon: d => d.geometry.coordinates[0],
      getElevation: getHeight,
      getFillColor: [58, 120, 194, 180],
      extruded: true,
      wireframe: false,
      pickable: true,
      onClick: info => {
        const props = info.object.properties;
        alert(`${props.name}\nYear Built: ${props.yearBuilt}\nStyle: ${props.style}\nDesigner: ${props.designer}`);
      }
    });

    roofLayer = new deck.PolygonLayer({
      id: 'roof-flat',
      data: data.features,
      getPolygon: d => d.geometry.coordinates[0],
      getElevation: getHeight,
      getFillColor: [58, 120, 194],
      extruded: false,
      pickable: false
    });

    deckgl = new deck.DeckGL({
      mapStyle: `https://api.mapbox.com/styles/v1/mapbox/streets-v12?access_token=${MAPBOX_TOKEN}`, // âœ… ä¿®å¤çš„ HTTPS ç‰ˆæœ¬
      initialViewState: INITIAL_VIEW_STATE,
      controller: true,
      layers: [wallLayer, roofLayer]
    });
  })
  .catch(err => {
    console.error("ðŸš¨ Failed to load GeoJSON file:", err);
  });
</script>
</body>
</html>

